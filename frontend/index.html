<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sport Agent - Your Daily Sports Digest</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* Sport-specific section styling */
    .sport-section {
      margin-bottom: 1.5rem;
      padding: 1.5rem;
      border-radius: 0.75rem;
      border-left: 4px solid;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .sport-section.football {
      border-color: #22c55e;
      background: linear-gradient(to right, #f0fdf4, #ffffff);
    }
    
    .sport-section.tennis {
      border-color: #eab308;
      background: linear-gradient(to right, #fefce8, #ffffff);
    }
    
    .sport-section.f1 {
      border-color: #ef4444;
      background: linear-gradient(to right, #fef2f2, #ffffff);
    }
    
    .sport-section h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #1f2937;
    }
    
    .sport-section h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #111827;
    }
    
    .match-info {
      margin: 0.5rem 0;
      padding: 0.75rem;
      background: rgba(255,255,255,0.5);
      border-radius: 0.5rem;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    
    .digest-content pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: inherit;
    }
  </style>
</head>
<body class="bg-slate-100 text-neutral-900 antialiased font-[Inter]">
  <!-- Nav -->
  <header class="border-b border-neutral-200 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-tr from-blue-900 via-blue-800 to-blue-700 text-white">
          <i data-lucide="trophy" class="h-5 w-5"></i>
        </span>
        <span class="text-lg font-semibold tracking-tight">Sport Agent</span>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="mx-auto max-w-7xl px-6 pt-10 pb-8">
    <div class="relative overflow-hidden rounded-2xl border border-neutral-200 bg-gradient-to-tr from-blue-900 via-blue-800 to-blue-700">
      <div class="absolute inset-0 opacity-20">
        <img alt="Sports action" class="h-full w-full object-cover"
             src="https://images.unsplash.com/photo-1461896836934-ffe607ba8211?q=80&w=2000&auto=format&fit=crop" />
      </div>
      <div class="relative grid gap-6 p-8 md:grid-cols-3 md:p-12">
        <div class="md:col-span-2">
          <h1 class="text-white text-4xl md:text-5xl font-semibold tracking-tight leading-tight">
            Your Personalized Sport Digest
          </h1>
          <p class="mt-3 text-blue-100/90 text-base md:text-lg">
            Never miss a game, score, or update. Get personalized daily sports briefings for all your favorite teams and players.
          </p>
          <div class="mt-6 flex flex-wrap items-center gap-3">
            <div class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-2 text-white text-sm">
              <i data-lucide="calendar" class="h-4 w-4"></i>
              Daily schedules
            </div>
            <div class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-2 text-white text-sm">
              <i data-lucide="activity" class="h-4 w-4"></i>
              Live scores
            </div>
            <div class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-2 text-white text-sm">
              <i data-lucide="users" class="h-4 w-4"></i>
              Player news
            </div>
          </div>
        </div>
        <div class="hidden md:block">
          <div class="relative h-full w-full rounded-xl bg-white/10 p-4 ring-1 ring-white/20 backdrop-blur">
            <img alt="Sports stadium" class="h-full w-full rounded-lg object-cover"
                 src="https://images.unsplash.com/photo-1522778119026-d647f0596c20?q=80&w=1600&auto=format&fit=crop" />
            <div class="absolute bottom-4 left-4 flex items-center gap-2 rounded-full bg-black/30 px-3 py-1.5 text-white text-xs">
              <i data-lucide="zap" class="h-3.5 w-3.5"></i> Real-time
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feature cards -->
    <div class="mt-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="rounded-xl border border-neutral-200 bg-white p-5 shadow-sm">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-blue-100 text-blue-700">
            <i data-lucide="calendar-clock" class="h-5 w-5"></i>
          </span>
          <div>
            <div class="font-semibold tracking-tight">Schedule Agent</div>
            <p class="text-sm text-neutral-600">Upcoming games and broadcast info.</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border border-neutral-200 bg-white p-5 shadow-sm">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-blue-100 text-blue-700">
            <i data-lucide="target" class="h-5 w-5"></i>
          </span>
          <div>
            <div class="font-semibold tracking-tight">Scores Agent</div>
            <p class="text-sm text-neutral-600">Recent results and standings.</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border border-neutral-200 bg-white p-5 shadow-sm">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-blue-100 text-blue-700">
            <i data-lucide="user-check" class="h-5 w-5"></i>
          </span>
          <div>
            <div class="font-semibold tracking-tight">Player Agent</div>
            <p class="text-sm text-neutral-600">News, injuries, and stats.</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border border-neutral-200 bg-white p-5 shadow-sm">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-blue-100 text-blue-700">
            <i data-lucide="mail" class="h-5 w-5"></i>
          </span>
          <div>
            <div class="font-semibold tracking-tight">Daily Digest</div>
            <p class="text-sm text-neutral-600">Automated morning briefings.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Configuration and Results -->
  <main class="mx-auto max-w-7xl px-6 pb-20">
    <div class="grid gap-6 lg:grid-cols-3">
      <!-- Configuration Form -->
      <section class="rounded-xl border border-neutral-200 bg-white p-6 shadow-sm">
        <h2 class="text-2xl font-semibold tracking-tight">Configure Your Interests</h2>
        <p class="mt-1 text-sm text-neutral-600">Tell us what teams and players you follow.</p>

        <form id="configForm" class="mt-6 space-y-4" autocomplete="off">
          <!-- Teams -->
          <div>
            <label for="teams" class="block text-sm font-medium text-neutral-800">Favorite Teams</label>
            <div class="mt-2 relative">
              <input id="teams" type="text" required placeholder="e.g., Lakers, Manchester United, Patriots"
                     class="w-full rounded-lg border border-neutral-300 bg-white px-3.5 py-2.5 text-neutral-900 placeholder-neutral-400 shadow-sm outline-none ring-0 focus:border-neutral-400 focus:ring-2 focus:ring-neutral-200" />
              <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400">
                <i data-lucide="shield" class="h-4.5 w-4.5"></i>
              </span>
            </div>
            <p class="mt-1 text-xs text-neutral-500">Comma-separated list</p>
          </div>

          <!-- Players -->
          <div>
            <label for="players" class="block text-sm font-medium text-neutral-800">Favorite Players (Optional)</label>
            <div class="mt-2 relative">
              <input id="players" type="text" placeholder="e.g., LeBron James, Cristiano Ronaldo"
                     class="w-full rounded-lg border border-neutral-300 bg-white px-3.5 py-2.5 text-neutral-900 placeholder-neutral-400 shadow-sm outline-none ring-0 focus:border-neutral-400 focus:ring-2 focus:ring-neutral-200" />
              <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400">
                <i data-lucide="user" class="h-4.5 w-4.5"></i>
              </span>
            </div>
            <p class="mt-1 text-xs text-neutral-500">Comma-separated list</p>
          </div>

          <!-- Leagues -->
          <div>
            <label for="leagues" class="block text-sm font-medium text-neutral-800">Leagues/Sports</label>
            <div class="mt-2 relative">
              <input id="leagues" type="text" required placeholder="e.g., NBA, NFL, Premier League"
                     class="w-full rounded-lg border border-neutral-300 bg-white px-3.5 py-2.5 text-neutral-900 placeholder-neutral-400 shadow-sm outline-none ring-0 focus:border-neutral-400 focus:ring-2 focus:ring-neutral-200" />
              <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400">
                <i data-lucide="trophy" class="h-4.5 w-4.5"></i>
              </span>
            </div>
            <p class="mt-1 text-xs text-neutral-500">Comma-separated list</p>
          </div>

          <!-- Delivery Time -->
          <div>
            <label for="deliveryTime" class="block text-sm font-medium text-neutral-800">Delivery Time</label>
            <div class="mt-2 relative">
              <input id="deliveryTime" type="time" value="07:00" required
                     class="w-full rounded-lg border border-neutral-300 bg-white px-3.5 py-2.5 text-neutral-900 shadow-sm outline-none ring-0 focus:border-neutral-400 focus:ring-2 focus:ring-neutral-200" />
              <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400">
                <i data-lucide="clock" class="h-4.5 w-4.5"></i>
              </span>
            </div>
          </div>

          <!-- Timezone -->
          <div>
            <label for="timezone" class="block text-sm font-medium text-neutral-800">Timezone</label>
            <select id="timezone" required
                    class="mt-2 w-full rounded-lg border border-neutral-300 bg-white px-3.5 py-2.5 text-neutral-900 shadow-sm outline-none ring-0 focus:border-neutral-400 focus:ring-2 focus:ring-neutral-200">
              <option value="America/Sao_Paulo">🇧🇷 Brasil (Brasília)</option>
              <option value="America/Los_Angeles">Pacific Time (PT)</option>
              <option value="America/Denver">Mountain Time (MT)</option>
              <option value="America/Chicago">Central Time (CT)</option>
              <option value="America/New_York">Eastern Time (ET)</option>
              <option value="Europe/London">London (GMT/BST)</option>
              <option value="Europe/Paris">Paris (CET/CEST)</option>
              <option value="Asia/Tokyo">Tokyo (JST)</option>
              <option value="Australia/Sydney">Sydney (AEST/AEDT)</option>
            </select>
          </div>

          <!-- Submit Button -->
          <div class="pt-2">
            <button type="submit"
                    class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-blue-900 px-4 py-3 text-white shadow-sm transition hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-300">
              <i data-lucide="save" class="h-5 w-5"></i>
              <span class="font-medium">Save Preferences</span>
            </button>
          </div>

          <!-- Generate Now Button -->
          <div id="generateNowSection" class="hidden">
            <button type="button" id="generateNowBtn"
                    class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-neutral-900 px-4 py-3 text-white shadow-sm transition hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-300">
              <i data-lucide="zap" class="h-5 w-5"></i>
              <span class="font-medium">Generate Digest Now</span>
            </button>
          </div>
        </form>
      </section>

      <!-- Digest Output -->
      <section class="lg:col-span-2 space-y-6">
        <div id="placeholderCard" class="rounded-xl border border-neutral-200 bg-white p-8 text-center shadow-sm">
          <h3 class="text-xl md:text-2xl font-semibold tracking-tight">Configure your sport interests</h3>
          <p class="mt-2 text-neutral-600">Enter your favorite teams, players, and leagues to get started.</p>
          <div class="mt-6 grid gap-3 sm:grid-cols-3">
            <div class="rounded-lg border border-neutral-200 p-4">
              <div class="flex items-center gap-2 text-neutral-700">
                <i data-lucide="calendar" class="h-4 w-4"></i>
                Game Schedule
              </div>
              <p class="mt-1 text-sm text-neutral-600">See upcoming games with times and channels.</p>
            </div>
            <div class="rounded-lg border border-neutral-200 p-4">
              <div class="flex items-center gap-2 text-neutral-700">
                <i data-lucide="activity" class="h-4 w-4"></i>
                Latest Scores
              </div>
              <p class="mt-1 text-sm text-neutral-600">Yesterday's results and highlights.</p>
            </div>
            <div class="rounded-lg border border-neutral-200 p-4">
              <div class="flex items-center gap-2 text-neutral-700">
                <i data-lucide="user" class="h-4 w-4"></i>
                Player Updates
              </div>
              <p class="mt-1 text-sm text-neutral-600">Injuries, news, and performance.</p>
            </div>
          </div>
        </div>

        <div id="results" class="hidden space-y-6"></div>
      </section>
    </div>
  </main>

  <footer class="border-t border-neutral-200 bg-white">
    <div class="mx-auto max-w-7xl px-6 py-10 text-sm text-neutral-600">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-2">
          <span class="inline-flex h-7 w-7 items-center justify-center rounded-md bg-blue-900 text-white">
            <i data-lucide="trophy" class="h-4.5 w-4.5"></i>
          </span>
          <span>&copy; <span id="year"></span> Sport Agent</span>
        </div>
        <div class="flex items-center gap-4">
          <a class="hover:text-neutral-900" href="#">Privacy</a>
          <a class="hover:text-neutral-900" href="#">Terms</a>
          <a class="hover:text-neutral-900" href="#">Support</a>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Initialize icons and year
    function renderIcons() { if (window.lucide) lucide.createIcons(); }
    document.getElementById('year').textContent = new Date().getFullYear();
    renderIcons();

    // Get user ID from localStorage or generate new one
    let userId = localStorage.getItem('sport_agent_user_id');

    const form = document.getElementById('configForm');
    const results = document.getElementById('results');
    const placeholderCard = document.getElementById('placeholderCard');
    const generateNowSection = document.getElementById('generateNowSection');
    const generateNowBtn = document.getElementById('generateNowBtn');

    // If user already has ID, show generate button
    if (userId) {
      generateNowSection.classList.remove('hidden');
      loadUserPreferences();
    }

    // Load user preferences if they exist
    async function loadUserPreferences() {
      if (!userId) return;
      
      try {
        const resp = await fetch(`/preferences/${userId}`);
        if (resp.ok) {
          const prefs = await resp.json();
          document.getElementById('teams').value = prefs.teams?.join(', ') || '';
          document.getElementById('players').value = prefs.players?.join(', ') || '';
          document.getElementById('leagues').value = prefs.leagues?.join(', ') || '';
          document.getElementById('deliveryTime').value = prefs.delivery_time || '07:00';
          document.getElementById('timezone').value = prefs.timezone || 'America/Los_Angeles';
        }
      } catch (err) {
        console.error('Error loading preferences:', err);
      }
    }

    // Save preferences
    async function savePreferences(e) {
      e.preventDefault();

      const teamsInput = (document.getElementById('teams').value || '').trim();
      const playersInput = (document.getElementById('players').value || '').trim();
      const leaguesInput = (document.getElementById('leagues').value || '').trim();
      const deliveryTime = document.getElementById('deliveryTime').value || '07:00';
      const timezone = document.getElementById('timezone').value || 'America/Los_Angeles';

      if (!teamsInput || !leaguesInput) {
        alert('Please enter at least your favorite teams and leagues.');
        return;
      }

      // Parse comma-separated values
      const teams = teamsInput.split(',').map(t => t.trim()).filter(t => t);
      const players = playersInput.split(',').map(p => p.trim()).filter(p => p);
      const leagues = leaguesInput.split(',').map(l => l.trim()).filter(l => l);

      const requestBody = {
        teams,
        players,
        leagues,
        delivery_time: deliveryTime,
        timezone: timezone,
        user_id: userId || null
      };

      try {
        const resp = await fetch('/configure-interests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        
        userId = data.user_id;
        localStorage.setItem('sport_agent_user_id', userId);
        
        generateNowSection.classList.remove('hidden');
        
        // Show success message
        results.classList.remove('hidden');
        placeholderCard.classList.add('hidden');
        results.innerHTML = `
          <div class="rounded-xl border border-green-200 bg-green-50 p-6">
            <div class="flex items-center gap-3 text-green-800">
              <i data-lucide="check-circle" class="h-6 w-6"></i>
              <div>
                <div class="font-semibold">Preferences Saved!</div>
                <p class="text-sm mt-1">Your daily digest will be generated at ${deliveryTime} ${timezone}.</p>
                <p class="text-sm">Click "Generate Digest Now" to see a preview.</p>
              </div>
            </div>
          </div>
        `;
        renderIcons();
      } catch (err) {
        alert('Failed to save preferences. Please try again.');
        console.error('Save error:', err);
      }
    }

    // Format digest by sport sections
    function formatDigestBySport(digest) {
      // Split by sport sections
      let formatted = digest;
      
      // Detect and wrap football section
      if (formatted.includes('⚽') || formatted.includes('FUTEBOL')) {
        formatted = formatted.replace(
          /(⚽\s*\*\*FUTEBOL\*\*[\s\S]*?)(?=🎾|🏎️|$)/,
          '<div class="sport-section football">$1</div>'
        );
      }
      
      // Detect and wrap tennis section
      if (formatted.includes('🎾') || formatted.includes('TÊNIS')) {
        formatted = formatted.replace(
          /(🎾\s*\*\*TÊNIS\*\*[\s\S]*?)(?=🏎️|$)/,
          '<div class="sport-section tennis">$1</div>'
        );
      }
      
      // Detect and wrap F1 section
      if (formatted.includes('🏎️') || formatted.includes('FÓRMULA 1')) {
        formatted = formatted.replace(
          /(🏎️\s*\*\*FÓRMULA 1\*\*[\s\S]*?)$/,
          '<div class="sport-section f1">$1</div>'
        );
      }
      
      // Convert markdown-style formatting to HTML
      formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      formatted = formatted.replace(/###\s+(.+)/g, '<h3>$1</h3>');
      formatted = formatted.replace(/^=+$/gm, '<hr style="border-color: #e5e7eb; margin: 1rem 0;">');
      
      // Convert line breaks to HTML
      formatted = formatted.replace(/\n/g, '<br>');
      
      // Wrap match info in styled divs
      formatted = formatted.replace(
        /(📊|📅|🏁|🏆|🇧🇷)\s*([^<]+?)<br>/g,
        '<div class="match-info">$1 $2</div>'
      );
      
      return formatted;
    }

    // Generate digest now
    async function generateDigest() {
      if (!userId) {
        alert('Please save your preferences first.');
        return;
      }

      placeholderCard.classList.add('hidden');
      results.classList.remove('hidden');
      results.innerHTML = `
        <div class="rounded-xl border border-neutral-200 bg-white p-6 shadow-sm">
          <div class="flex items-center gap-3 text-neutral-700">
            <i data-lucide="loader-2" class="h-5 w-5 animate-spin"></i>
            Generating your personalized sport digest... (this may take 10-30 seconds)
          </div>
        </div>
      `;
      renderIcons();

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
        
        const resp = await fetch('/generate-digest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!resp.ok) {
          const errorText = await resp.text();
          console.error('Server error:', errorText);
          throw new Error(`HTTP ${resp.status}: ${errorText}`);
        }
        
        const data = await resp.json();
        const digestContent = (data && data.digest) ? data.digest : 'No digest generated';

        // Format digest with sport-specific sections
        const formattedDigest = formatDigestBySport(digestContent);
        
        results.innerHTML = `
          <div class="rounded-xl border border-neutral-200 bg-white p-6 shadow-sm">
            <div class="mb-4 flex items-center justify-between">
              <h3 class="text-xl font-semibold tracking-tight">Seu Digest Esportivo</h3>
              <div class="text-sm text-neutral-600">${new Date().toLocaleString('pt-BR')}</div>
            </div>
            <div class="digest-content">${formattedDigest}</div>
          </div>
        `;
        renderIcons();
      } catch (err) {
        let errorMsg = 'Failed to generate digest. Please try again.';
        if (err.name === 'AbortError') {
          errorMsg = 'Request timed out. The digest generation is taking longer than expected. Please try again.';
        } else if (err.message) {
          errorMsg = `Error: ${err.message}`;
        }
        
        results.innerHTML = `
          <div class="rounded-xl border border-red-200 bg-red-50 p-6 text-red-700">
            <div class="flex items-center gap-2">
              <i data-lucide="alert-triangle" class="h-5 w-5"></i>
              <div>
                <div class="font-semibold">Failed to Generate Digest</div>
                <p class="text-sm mt-1">${errorMsg}</p>
                <p class="text-sm mt-2">Check the browser console (F12) for more details.</p>
              </div>
            </div>
          </div>
        `;
        renderIcons();
        console.error('Generate error:', err);
      }
    }

    form.addEventListener('submit', savePreferences);
    generateNowBtn?.addEventListener('click', generateDigest);
  </script>
</body>
</html>
